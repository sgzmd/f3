version: '3.3'
services: 
    database:
      image: mariadb:latest
      ports:
        - 3306:3306
      volumes:
        - flibudata:/var/lib/mysql
      environment:
        - MYSQL_ROOT_PASSWORD=toor
        - MYSQL_PASSWORD=flibusta
        - MYSQL_USER=flibustier
        - MYSQL_DATABASE=flibustier
    flibuserver:
      build:
        context: .
        args:
          - telegram_api_key=${ENV_TELEGRAM_API_KEY}
          - telegram_chat_id=${ENV_TELEGRAM_CHAT_ID}
      links:
        - database
      depends_on:
        - database
      volumes:
          - 'flibudata:/var/local/flibudata'
      ports:
          - '9000:9000'
      # environment:
      #     - telegram_api_key=${ENV_TELEGRAM_API_KEY}
      #     - telegram_chat_id=${ENV_TELEGRAM_CHAT_ID}
      restart: unless-stopped
      healthcheck:
            test: ["CMD", "./grpc_health_probe-linux-amd64", "-addr=localhost:9000"]
            interval: 30s
            timeout: 30s
            retries: 99999
    web:
      build: ../web
      depends_on:
        flibuserver:
          condition: service_healthy 
      ports:
        - '8080:8080'
      environment:
        - telegram_api_key=none
        - backend_uirl=localhost:9000
        - web_port=8080
        - bot_name=none
        - domain_name=none
volumes:
  flibudata: