version: '3.3'
services: 
    database:
      image: mariadb:latest
      ports:
        - 3366:3306
      volumes:
        - flibudata:/var/lib/mysql
      environment:
        - MYSQL_ROOT_PASSWORD=toor
        - MYSQL_PASSWORD=${ENV_MARIADB_PASSWORD}
        - MYSQL_USER=${ENV_MARIADB_USER}
        - MYSQL_DATABASE=${ENV_MARIADB_DATABASE}
    flibuserver:
      build:
        context: .
        args:
          - telegram_api_key=${ENV_TELEGRAM_API_KEY}
          - telegram_chat_id=${ENV_TELEGRAM_CHAT_ID}
          - mariadb_host=database
          - mariadb_user=${ENV_MARIADB_USER}
          - mariadb_port=3306
          - mariadb_password=${ENV_MARIADB_PASSWORD}
          - mariadb_database=${ENV_MARIADB_DATABASE}
          - flibusta_base_url=${ENV_FLIBUSTA_BASE_URL}
      links:
        - database
      depends_on:
        - database
      volumes:
          - 'flibudata:/var/local/flibudata'
      ports:
          - '9000:9000'
      restart: unless-stopped
      healthcheck:
            test: ["CMD", "./grpc_health_probe-linux-amd64", "-addr=localhost:9000"]
            interval: 30s
            timeout: 30s
            retries: 99999
    web:
      build: 
        context: ../web
        args:
          - telegram_api_key=${ENV_TELEGRAM_API_KEY}
          - telegram_chat_id=${ENV_TELEGRAM_CHAT_ID}
          - backend_url=flibuserver:9000
          - web_port=8088
          - bot_name=${ENV_BOT_NAME}
          - domain_name=${ENV_DOMAIN_NAME}

      depends_on:
        flibuserver:
          condition: service_healthy 
      ports:
        - '8088:8088'
volumes:
  flibudata: